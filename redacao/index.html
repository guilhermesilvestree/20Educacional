<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redação | Evolução Educacional</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="assets/icon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>

    <style>
        :root {
            --cor-fundo: #F4F4F6;
            --cor-container: #FFFFFF;
            --cor-texto-principal: #333A45;
            --cor-texto-sutil: #7A8291;
            --cor-borda: #EAEBEE;
            --cor-acento: #00A8FF;
            --cor-acento-hover: #008DD1;
            --cor-alerta: #E5A05B;
            --cor-perigo: #C96464;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        html, body {
            height: 100%;
            background-color: var(--cor-fundo);
            color: var(--cor-texto-principal);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        #constellation-background {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; z-index: 0;
        }

        .page-container {
            width: 100%;
            max-width: 1100px;
            position: relative; z-index: 1;
            display: flex; justify-content: center;
        }
        
        .step-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: var(--cor-container);
            border-radius: 15px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--cor-borda);
            padding: 50px;
            animation: fadeIn 0.6s ease;
            width: 100%;
        }

        .step-container.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .back-button-fixed {
            position: fixed; top: 30px; left: 30px; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; 
            background: var(--cor-container);
            color: var(--cor-acento); 
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--cor-borda);
            text-decoration: none; font-size: 1rem;
            transition: all 0.3s ease;
        }
        .back-button-fixed:hover { transform: scale(1.1); }
        
        h1 {
            font-size: 2.2rem; font-weight: 700;
            color: var(--cor-acento); text-align: center;
        }
        p { 
            font-size: 1.1rem; color: var(--cor-texto-sutil); 
            text-align: center; line-height: 1.7;
            max-width: 550px;
        }

        .action-button {
            margin-top: 10px;
            padding: 14px 35px; font-size: 1.1rem; font-weight: 600;
            border-radius: 50px; border: none; cursor: pointer;
            transition: all 0.3s ease;
            color: #FFFFFF; background-color: var(--cor-acento);
            box-shadow: 0 4px 15px rgba(0, 168, 255, 0.25);
        }
        .action-button:hover { background-color: var(--cor-acento-hover); transform: translateY(-2px); }
        .action-button:disabled {
            background-color: #B0B8C5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #instructions-step ul { 
            list-style: none; padding: 0; 
            width: 100%; max-width: 600px; margin-top: 20px;
        }
        #instructions-step li {
            display: flex; align-items: flex-start; gap: 20px;
            margin-bottom: 25px; color: var(--cor-texto-principal);
            line-height: 1.6; font-size: 1rem;
        }
        #instructions-step li i {
            color: var(--cor-acento); font-size: 1.3rem;
            margin-top: 3px; width: 25px; text-align: center;
        }

        .preparation-gif {
            width: 180px;
            height: auto;
            margin-bottom: 10px;
        }
        
        #writing-step {
            padding: 20px;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            -moz-user-select: none;
            background-color: #F9FAFB;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .writing-dashboard {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--cor-borda);
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.0rem;
            font-weight: 500;
        }
        
        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        #student-name-display {
            font-weight: 600;
        }

        .datetime-info {
            font-size: 0.9rem;
            color: var(--cor-texto-sutil);
            text-align: right;
        }
        #current-time { font-weight: 600; }

        .dashboard-main {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
        }

        .left-column {
            flex: 1 1 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 280px;
        }
        .right-column {
            flex: 2 1 400px;
            display: flex;
        }

        .widget {
            background: var(--cor-container);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid var(--cor-borda);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .widget-title {
            font-size: 1.0rem;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--cor-borda);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .widget-title i { color: var(--cor-acento); }

        .timer-widget { align-items: center; }
        .timer-container { position: relative; width: 160px; height: 160px; }
        .timer-svg { transform: rotate(-90deg); }
        .timer-bg, .timer-progress { fill: none; stroke-width: 12; }
        .timer-bg { stroke: var(--cor-borda); }
        .timer-progress { stroke: var(--cor-acento); stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.5s; }
        .timer-progress.warning { stroke: var(--cor-alerta); }
        .timer-progress.danger { stroke: var(--cor-perigo); animation: timerFlash 1s infinite; }
        
        #timer-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.0rem;
        }

        #checklist-lembretes { list-style: none; padding: 0; }
        #checklist-lembretes li {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            color: var(--cor-texto-sutil);
            font-size: 0.9rem;
        }
        #checklist-lembretes i {
            color: var(--cor-sucesso, #28a745);
            font-size: 1.0rem;
        }
        
        #theme-title { 
            color: var(--cor-texto-principal); 
            font-size: 1.3rem; 
            font-weight: 600; 
            text-align: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--cor-borda);
        }
        #theme-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--cor-texto-sutil);
            flex-grow: 1;
            text-align: center;
        }
        
        @keyframes timerFlash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        #times-up-step .times-up-icon {
            width: 80px; height: 80px;
            color: var(--cor-acento); margin-bottom: 15px;
            animation: pulseIcon 2s infinite ease-in-out;
        }

        @keyframes pulseIcon {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.08); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        .auto-redirect-indicator {
            margin-top: 30px; width: 100%;
            max-width: 350px; text-align: center;
        }

        .auto-redirect-indicator .redirect-text {
            font-size: 0.95rem; color: var(--cor-texto-sutil);
            margin-bottom: 12px;
        }

        .progress-bar-container {
            width: 100%; height: 8px; background-color: var(--cor-borda);
            border-radius: 4px; overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .progress-bar-fill {
            width: 0%; height: 100%; background-color: var(--cor-acento);
            border-radius: 4px;
            animation: fillProgressBar 4s linear forwards;
        }

        @keyframes fillProgressBar { from { width: 0%; } to { width: 100%; } }
        
        #submission-step { max-width: 650px; text-align: left; align-items: stretch; gap: 25px; }

        .submission-header {
            display: flex; align-items: center; gap: 15px;
            padding-bottom: 20px; border-bottom: 1px solid var(--cor-borda);
        }
        .submission-header .user-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background-color: var(--cor-borda);
            flex-shrink: 0;
            overflow: hidden; 
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .submission-header .user-details { flex-grow: 1; }
        .submission-header #submission-student-name {
            font-weight: 600; font-size: 1.2rem;
            color: var(--cor-texto-principal);
        }
        .submission-header #submission-time {
            font-size: 0.9rem; color: var(--cor-texto-sutil);
        }

        .submission-summary {
            background-color: #F9FAFB; padding: 20px;
            border-radius: 16px; border: 1px solid var(--cor-borda);
        }
        .submission-summary h3 {
            font-size: 1rem; font-weight: 600; margin-bottom: 8px;
            color: var(--cor-texto-principal);
        }
        .submission-summary p {
            font-size: 0.95rem; text-align: left; max-width: 100%;
            line-height: 1.6;
        }
        
        #submission-step > p { text-align: center; max-width: 100%; }

        .upload-area {
            border: 2px dashed var(--cor-acento);
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color: 0.3s ease, border-color: 0.3s ease;
            background-color: #F9FAFB;
        }
        .upload-area:hover { 
            background-color: #F0F5FA;
            border-color: var(--cor-acento-hover);
        }
        .upload-area i { 
            font-size: 3rem;
            color: var(--cor-acento); 
            margin-bottom: 15px; 
        }
        .upload-area p { 
            font-size: 1.1rem;
            font-weight: 600; 
            color: var(--cor-texto-principal);
        }
        .upload-area span { 
            font-size: 0.9rem;
            color: var(--cor-texto-sutil); 
        }
        #photo-input { display: none; }

        .photo-tips-link {
            color: var(--cor-acento); text-decoration: none;
            font-weight: 500; font-size: 0.9rem;
            cursor: pointer; text-align: center;
        }
        .photo-tips-link:hover { text-decoration: underline; }

        #submission-status {
            font-size: 0.9rem; margin-top: 5px; min-height: 1.2em;
            color: var(--cor-texto-sutil); text-align: center;
        }

        .modal-backdrop {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 100;
            display: none;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-backdrop.active { display: flex; }
        .modal-content {
            background: var(--cor-container);
            padding: 40px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 90%; max-width: 550px;
            animation: fadeIn 0.4s ease;
            text-align: center;
        }
        .modal-content h2 {
            text-align: center; margin-bottom: 15px;
            font-size: 1.6rem; color: var(--cor-texto-principal);
        }
        .tips-list { list-style: none; padding: 0; margin-bottom: 30px; }
        .tips-list li {
            display: flex; align-items: flex-start; gap: 20px;
            margin-bottom: 20px;
        }
        .tips-list li i {
            font-size: 1.5rem; color: var(--cor-acento);
            margin-top: 2px;
        }
        .tips-list li p {
            text-align: left; font-size: 1rem;
            color: var(--cor-texto-sutil); line-height: 1.6;
        }

        @media (max-width: 768px) {
            .step-container { padding: 40px 25px; }
            h1 { font-size: 1.8rem; }
            .preparation-gif { width: 150px; }
            .dashboard-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .datetime-info { text-align: left; }
            #writing-step { padding: 25px 15px; }
        }
    </style>
</head>
<body>
    
    <canvas id="constellation-background"></canvas>

    <a href="../linguagens.html" class="back-button-fixed">
        <i class="fa-solid fa-chevron-left"></i>
    </a>

    <div class="page-container">
        
        <div id="instructions-step" class="step-container active">
            <h1>Sua Jornada de Escrita</h1>
            <p>Prepare-se para transformar suas ideias em palavras. Siga as diretrizes para uma redação de sucesso.</p>
            <ul>
                <li><i class="fa-solid fa-hourglass-half"></i><div><strong>Tempo de Foco:</strong> Você terá 2 horas para desenvolver seu texto.</div></li>
                <li><i class="fa-solid fa-file-pen"></i><div><strong>Estrutura:</strong> Escreva um texto dissertativo-argumentativo com até 30 linhas.</div></li>
                <li><i class="fa-solid fa-lightbulb"></i><div><strong>Argumentação:</strong> Defenda seu ponto de vista com argumentos claros, consistentes e bem fundamentados.</div></li>
                <li><i class="fa-solid fa-people-group"></i><div><strong>Proposta de Intervenção:</strong> Elabore uma solução para o problema, respeitando os direitos humanos.</div></li>
                <li><i class="fa-solid fa-pen-nib"></i><div><strong>Material:</strong> Utilize caneta de tinta preta e escreva em uma folha de papel.</div></li>
            </ul>
            <button id="understand-button" class="action-button">Entendi, vamos começar!</button>
        </div>

        <div id="preparation-step" class="step-container">
            <img src="assets/anim_escrevendo.gif" class="preparation-gif" alt="Animação de uma pessoa se preparando para escrever">
            <h1>Momento de Preparação</h1>
            <p>Organize seus materiais e encontre um lugar tranquilo. Respire fundo. Sua jornada de escrita começa agora.</p>
            <button id="start-button" class="action-button">Estou Pronto para Iniciar</button>
        </div>

        <div id="writing-step" class="step-container">
            <div class="writing-dashboard">
                <header class="dashboard-header">
                    <div class="user-info">
                        <img id="writing-user-avatar-img" src="assets/gui.jpeg" alt="Avatar" class="user-avatar-small">
                        <span>Olá, <strong id="student-name-display">...</strong></span>
                    </div>
                    <div class="datetime-info">
                        <span id="current-date">--/--/----</span>
                        <br>
                        <span id="current-time">--:--:--</span>
                    </div>
                </header>

                <main class="dashboard-main">
                    <div class="left-column">
                        <div class="widget timer-widget">
                            <h3 class="widget-title"><i class="fa-solid fa-stopwatch"></i>Tempo Restante</h3>
                            <div class="timer-container">
                                <svg class="timer-svg" width="160" height="160" viewBox="0 0 160 160">
                                    <circle class="timer-bg" cx="80" cy="80" r="74"></circle>
                                    <circle id="timer-progress" class="timer-progress" cx="80" cy="80" r="74"></circle>
                                </svg>
                                <div id="timer-text">02:00:00</div>
                            </div>
                        </div>
                        <div class="widget">
                            <h3 class="widget-title"><i class="fa-solid fa-list-check"></i>Checklist</h3>
                             <ul id="checklist-lembretes">
                                <li><i class="fa-solid fa-check-circle"></i> Dissertativo-argumentativo</li>
                                <li><i class="fa-solid fa-check-circle"></i> Proposta de intervenção</li>
                                <li><i class="fa-solid fa-check-circle"></i> Respeito aos direitos humanos</li>
                                <li><i class="fa-solid fa-check-circle"></i> Mínimo de 7 linhas</li>
                                <li><i class="fa-solid fa-check-circle"></i> Máximo de 30 linhas</li>
                            </ul>
                        </div>
                    </div>

                    <div class="right-column">
                        <div class="widget theme-widget">
                             <h3 class="widget-title"><i class="fa-solid fa-book-open"></i>Tema da Redação</h3>
                            <h2 id="theme-title">Tema da Redação</h2>
                            <p id="theme-text">Texto motivador será carregado aqui.</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="times-up-step" class="step-container">
            <svg class="times-up-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h1>Tempo Esgotado!</h1>
            <p>Excelente esforço! Pare de escrever e prepare-se para enviar sua redação.</p>
            <div class="auto-redirect-indicator">
                <p class="redirect-text">Avançando para a etapa de envio...</p>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill"></div>
                </div>
            </div>
        </div>

        <div id="submission-step" class="step-container">
            <header class="submission-header">
                <div class="user-avatar">
                    <img id="user-avatar-img" src="assets/gui.jpeg" alt="Avatar do Aluno">
                </div>
                <div class="user-details">
                    <span id="submission-student-name">Carregando...</span>
                    <div id="submission-time">Finalizado em --/--/---- às --:--</div>
                </div>
            </header>

            <div class="submission-summary">
                <h3>Resumo da Atividade</h3>
                <p id="submission-theme-title">Carregando tema da redação...</p>
            </div>

            <p>Tire uma foto nítida da sua redação. Nossa plataforma irá transcrever e preparar seu texto para a avaliação.</p>
            <a id="open-tips-modal" class="photo-tips-link">Ver dicas para uma boa foto</a>

            <label for="photo-input" class="upload-area" id="upload-area">
                <i class="fa-solid fa-camera"></i>
                <p id="upload-area-text">Abrir Câmera</p>
                <span>Fotografe a folha inteira da sua redação</span>
            </label>
            <input type="file" id="photo-input" accept="image/*" capture="environment">
            <button class="action-button" id="submit-essay-button" disabled>Enviar Redação</button>

            <p id="submission-status"></p>
        </div>
    </div>

    <div class="modal-backdrop" id="modal-backdrop">
        <div class="modal-content">
            <h2>Dicas para uma Foto Perfeita</h2>
            
            <div id="lottie-animation-container" style="width: 150px; height: 150px; margin: 0 auto 20px;"></div>

            <ul class="tips-list">
                <li>
                    <i class="fa-solid fa-lightbulb"></i>
                    <p><strong>Iluminação:</strong> Procure um local bem iluminado, de preferência com luz natural. Evite sombras fortes sobre o texto.</p>
                </li>
                <li>
                    <i class="fa-solid fa-expand"></i>
                    <p><strong>Enquadramento:</strong> Posicione a câmera diretamente acima da folha. Certifique-se de que a folha inteira apareça na foto, sem cortar as margens.</p>
                </li>
                <li>
                    <i class="fa-solid fa-camera"></i>
                    <p><strong>Foco e Nitidez:</strong> Segure o celular com firmeza e toque na tela para focar no centro do texto. Verifique se a imagem está nítida antes de enviar.</p>
                </li>
            </ul>
            <button class="action-button" id="close-tips-modal">Entendi</button>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL DA PÁGINA -->
    <script type="module">
        // ========================================================
        // ==  IMPORTAÇÕES DOS MÓDULOS                          ==
        // ========================================================
        import { auth } from './firebase-config.js';
        import { signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { gerarIdDocumento, definirDocumento, uploadArquivoCloudinary } from './firebase-services.js';

        // ========================================================
        // ==  VARIÁVEIS GLOBAIS E ELEMENTOS DO DOM              ==
        // ========================================================
        const steps = {
            instructions: document.getElementById('instructions-step'),
            preparation: document.getElementById('preparation-step'),
            writing: document.getElementById('writing-step'),
            timesUp: document.getElementById('times-up-step'),
            submission: document.getElementById('submission-step')
        };

        const understandButton = document.getElementById('understand-button');
        const startButton = document.getElementById('start-button');
        const photoInput = document.getElementById('photo-input');
        const submissionStatus = document.getElementById('submission-status');
        const submitEssayButton = document.getElementById('submit-essay-button');
        
        const studentNameDisplay = document.getElementById('student-name-display');
        const currentDateDisplay = document.getElementById('current-date');
        const currentTimeDisplay = document.getElementById('current-time');
        
        let currentTheme = null;
        let timerInterval;
        let currentRemainingSeconds;
        let currentStudentName = "";
        const TOTAL_ESSAY_TIME = 7200; // 2 horas em segundos
        const MOCKED_AVATAR_URL = 'assets/gui.jpeg';

        // ========================================================
        // ==  LÓGICA DE NAVEGAÇÃO E CONTROLE DOS PASSOS (STEPS) ==
        // ========================================================
        function showStep(stepName) {
            Object.values(steps).forEach(step => step.classList.remove('active'));
            steps[stepName].classList.add('active');
        }

        understandButton.addEventListener('click', () => showStep('preparation'));
        
        startButton.addEventListener('click', () => {
            const randomTheme = themes[Math.floor(Math.random() * themes.length)];
            startEssay(randomTheme);
        });

        function startEssay(theme) {
            showStep('writing');
            currentTheme = theme;
            
            document.getElementById('theme-title').innerText = theme.title;
            document.getElementById('theme-text').innerText = theme.text;
            
            const mockStudentName = "Guilherme Silvestre"; 
            currentStudentName = mockStudentName;
            studentNameDisplay.innerText = currentStudentName;
            
            document.getElementById('writing-user-avatar-img').src = MOCKED_AVATAR_URL;

            const sessionData = {
                creationTime: Date.now(),
                remainingSeconds: TOTAL_ESSAY_TIME,
                theme: theme,
                studentName: currentStudentName,
                status: 'writing'
            };
            localStorage.setItem('essaySession', JSON.stringify(sessionData));

            startTimer(TOTAL_ESSAY_TIME);
        }

        // ========================================================
        // == LÓGICA DA TELA DE SUBMISSÃO E MODAL DE DICAS       ==
        // ========================================================
        const modalBackdrop = document.getElementById('modal-backdrop');
        const openTipsModalLink = document.getElementById('open-tips-modal');
        const closeTipsModalButton = document.getElementById('close-tips-modal');
        let lottieAnimation = null;

        function toggleModal(show) {
            modalBackdrop.classList.toggle('active', show);
        }

        openTipsModalLink.addEventListener('click', () => {
            toggleModal(true);
            if (!lottieAnimation) {
                lottieAnimation = lottie.loadAnimation({
                    container: document.getElementById('lottie-animation-container'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'assets/gifs/photo.lottie'
                });
            }
        });

        closeTipsModalButton.addEventListener('click', () => toggleModal(false));
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) toggleModal(false);
        });
        
        function prepareSubmissionStep() {
            const now = new Date();
            const date = now.toLocaleDateString('pt-BR');
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            document.getElementById('submission-student-name').textContent = currentStudentName;
            document.getElementById('submission-time').textContent = `Finalizado em ${date} às ${time}`;
            if(currentTheme) {
                document.getElementById('submission-theme-title').textContent = currentTheme.title;
            }
            document.getElementById('user-avatar-img').src = MOCKED_AVATAR_URL;
        }

        // ========================================================
        // ==  LÓGICA DA REDAÇÃO (TEMA E TIMER)                  ==
        // ========================================================
        const themes = [
            { title: "Desafios para a valorização de comunidades e povos tradicionais no Brasil", text: "“Os povos e comunidades tradicionais são grupos culturalmente diferenciados e que se reconhecem como tais, que possuem formas próprias de organização social, que ocupam e usam territórios e recursos naturais como condição para sua reprodução cultural, social, religiosa, ancestral e econômica, utilizando conhecimentos, inovações e práticas gerados e transmitidos pela tradição.” (Política Nacional de Desenvolvimento Sustentável dos Povos e Comunidades Tradicionais)" },
            { title: "Invisibilidade e registro civil: garantia de acesso à cidadania no Brasil", text: "“Toda pessoa tem direito ao nome e ao sobrenome. Além disso, o registro de nascimento é fundamental para que um indivíduo seja reconhecido como cidadão. No Brasil, embora a certidão de nascimento seja um direito e gratuita, milhões de pessoas ainda vivem à margem desse direito, enfrentando a invisibilidade social e a negação de acesso a programas e políticas públicas.”" },
            { title: "O estigma associado às doenças mentais na sociedade brasileira", text: "“A saúde mental é um tema que tem ganhado visibilidade, mas o estigma e o preconceito ainda são barreiras significativas. Muitas pessoas evitam buscar ajuda por medo do julgamento, o que agrava quadros clínicos e perpetua um ciclo de sofrimento e exclusão. A desinformação é um dos principais fatores que alimentam essa realidade.”" }
        ];
        
        function handleTimesUp() {
            const sessionData = JSON.parse(localStorage.getItem('essaySession') || '{}');
            if (sessionData.studentName) {
                sessionData.status = 'timesUp';
                localStorage.setItem('essaySession', JSON.stringify(sessionData));
            }

            showStep('timesUp');
            prepareSubmissionStep();
            
            setTimeout(() => {
                const currentSessionData = JSON.parse(localStorage.getItem('essaySession') || '{}');
                if (currentSessionData.studentName) {
                    currentSessionData.status = 'submission';
                    localStorage.setItem('essaySession', JSON.stringify(currentSessionData));
                }
                showStep('submission');
            }, 4000);
        }

        const timerText = document.getElementById('timer-text');
        const timerProgress = document.getElementById('timer-progress');
        
        function setProgress(percent) {
            const radius = timerProgress.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            timerProgress.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - (percent / 100) * circumference;
            timerProgress.style.strokeDashoffset = offset;
        }

        function startTimer(duration) {
            clearInterval(timerInterval);
            currentRemainingSeconds = Number(duration) || 0;

            const updateDisplay = () => {
                let hours = Math.floor(currentRemainingSeconds / 3600);
                let minutes = Math.floor((currentRemainingSeconds % 3600) / 60);
                let seconds = Math.floor(currentRemainingSeconds % 60);
                
                hours = hours < 10 ? "0" + hours : hours;
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timerText.textContent = `${hours}:${minutes}:${seconds}`;
                
                const progressPercent = (currentRemainingSeconds / TOTAL_ESSAY_TIME) * 100;
                setProgress(progressPercent);
                
                timerProgress.classList.remove('warning', 'danger');
                if (currentRemainingSeconds <= 60) { timerProgress.classList.add('danger'); } 
                else if (currentRemainingSeconds <= 300) { timerProgress.classList.add('warning'); }
            };

            updateDisplay();

            timerInterval = setInterval(() => {
                if (--currentRemainingSeconds < 0) {
                    clearInterval(timerInterval);
                    handleTimesUp();
                } else {
                    updateDisplay();
                }
            }, 1000);
        }

        function updateDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            currentDateDisplay.textContent = now.toLocaleDateString('pt-BR', dateOptions);
            currentTimeDisplay.textContent = now.toLocaleTimeString('pt-BR');
        }
        
        setInterval(updateDateTime, 1000);
        updateDateTime();

        function restoreSession() {
            const savedSessionJSON = localStorage.getItem('essaySession');
            if (!savedSessionJSON) {
                showStep('instructions');
                return;
            }
            
            const sessionData = JSON.parse(savedSessionJSON);

            currentTheme = sessionData.theme;
            currentStudentName = sessionData.studentName;

            if (sessionData.status === 'submission') {
                prepareSubmissionStep();
                showStep('submission');
                return;
            }

            if (sessionData.status === 'timesUp') {
                prepareSubmissionStep();
                showStep('timesUp');
                setTimeout(() => {
                    sessionData.status = 'submission';
                    localStorage.setItem('essaySession', JSON.stringify(sessionData));
                    showStep('submission');
                }, 4000);
                return;
            }
            
            const elapsedTime = (Date.now() - sessionData.creationTime) / 1000;
            const remainingSeconds = sessionData.remainingSeconds - elapsedTime;

            if (remainingSeconds <= 0) {
                handleTimesUp();
                return;
            }
            
            showStep('writing');
            document.getElementById('theme-title').innerText = currentTheme.title;
            document.getElementById('theme-text').innerText = currentTheme.text;
            studentNameDisplay.innerText = currentStudentName;
            document.getElementById('writing-user-avatar-img').src = MOCKED_AVATAR_URL;
            startTimer(remainingSeconds);
        }
        
        function saveCurrentTime() {
            const savedSessionJSON = localStorage.getItem('essaySession');
            if (!savedSessionJSON || !currentTheme) return;
            const sessionData = JSON.parse(savedSessionJSON);
            sessionData.remainingSeconds = currentRemainingSeconds;
            sessionData.creationTime = Date.now();
            localStorage.setItem('essaySession', JSON.stringify(sessionData));
        }

        document.addEventListener('DOMContentLoaded', () => {
            signInAnonymously(auth)
                .then(() => console.log("Usuário autenticado anonimamente para a sessão."))
                .catch(error => { console.error("Erro no login anônimo:", error); });
            restoreSession();
            window.addEventListener('beforeunload', saveCurrentTime);
        });

        // ========================================================
        // ==  LÓGICA DE UPLOAD E SUBMISSÃO                      ==
        // ========================================================
        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('upload-area-text').textContent = file.name;
                submitEssayButton.disabled = false;
            }
        });

        submitEssayButton.addEventListener('click', () => {
            const file = photoInput.files[0];
            if (file) {
                handlePhotoUpload(file);
            } else {
                alert("Por favor, selecione uma foto antes de enviar.");
            }
        });
        
        async function getGeminiAnalysis(theme, text) {
            const apiKey = "AIzaSyB7ygXwm0Zw39QrS9oV6D8P1qqZ5BmRhrM";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const schema = {
                type: "OBJECT",
                properties: {
                    grades: {
                        type: "OBJECT",
                        properties: {
                            competencia1: { type: "NUMBER", description: "Nota de 0 a 200 para a competência 1." },
                            competencia2: { type: "NUMBER", description: "Nota de 0 a 200 para a competência 2." },
                            competencia3: { type: "NUMBER", description: "Nota de 0 a 200 para a competência 3." },
                            competencia4: { type: "NUMBER", description: "Nota de 0 a 200 para a competência 4." },
                            competencia5: { type: "NUMBER", description: "Nota de 0 a 200 para a competência 5." },
                            total: { type: "NUMBER", description: "Soma das 5 competências." },
                        },
                    },
                    feedback: {
                        type: "OBJECT",
                        properties: {
                            positive: { type: "STRING", description: "Feedback sobre os pontos positivos." },
                            difficulties: { type: "STRING", description: "Feedback sobre as dificuldades e pontos a melhorar." },
                            suggestions: { type: "STRING", description: "Sugestões práticas para o aluno evoluir." },
                        },
                    },
                },
            };

            const prompt = `Analise a seguinte redação com o tema "${theme}". Avalie-a com base nas 5 competências do ENEM, atribuindo uma nota de 0 a 200 para cada uma, sempre em múltiplos de 40. Calcule a nota total (soma das 5 competências). Forneça também um feedback estruturado com pontos positivos, dificuldades encontradas e sugestões de melhoria. A redação é: \n\n"${text}"`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);

            } catch (error) {
                console.error("Erro ao chamar a API do Gemini:", error);
                // Fallback em caso de erro na API
                return {
                    grades: { competencia1: 0, competencia2: 0, competencia3: 0, competencia4: 0, competencia5: 0, total: 0 },
                    feedback: { positive: "Não foi possível analisar.", difficulties: "Ocorreu um erro.", suggestions: "Tente novamente mais tarde." }
                };
            }
        }
        
        async function handlePhotoUpload(file) {
            if (!currentStudentName || !currentTheme) {
                alert('Erro: Dados da sessão (nome ou tema) não encontrados.');
                return;
            }
            const user = auth.currentUser;
            if (!user) {
                alert('Erro de autenticação. A página será recarregada.');
                location.reload();
                return;
            }

            submitEssayButton.disabled = true;
            submitEssayButton.textContent = 'Enviando...';
            submissionStatus.textContent = 'Aguarde, enviando sua redação para o Cloudinary...';

            try {
                const essayId = gerarIdDocumento("essays");
                const sanitizedStudentName = currentStudentName.replace(/\s+/g, '-').toLowerCase();
                const publicFilename = `${sanitizedStudentName}-${essayId}`;
                
                // 1. Faz o upload para o Cloudinary com o nome de arquivo personalizado
                const fileURL = await uploadArquivoCloudinary(file, publicFilename);
                
                submissionStatus.textContent = 'Analisando com a IA...';
                
                // 2. Simula a transcrição e chama a análise REAL da IA
                const simulatedTranscribedText = `(Texto simulado extraído da imagem)\n\nA questão do estigma associado às doenças mentais no Brasil é uma barreira silenciosa que impede o progresso social. É fundamental que a sociedade discuta abertamente o tema para desconstruir preconceitos e oferecer o suporte necessário a quem precisa. A proposta de intervenção deve focar na educação e na ampliação do acesso a tratamentos psicológicos pelo sistema público de saúde.`;
                const analysis = await getGeminiAnalysis(currentTheme.title, simulatedTranscribedText);

                const essayData = {
                    id: essayId,
                    studentName: currentStudentName,
                    themeTitle: currentTheme.title,
                    essayImageURL: fileURL, // URL do Cloudinary
                    submissionDate: serverTimestamp(),
                    status: 'nao-corrigido', // Status inicial
                    transcribedText: simulatedTranscribedText,
                    feedback: analysis.feedback,
                    grades: analysis.grades
                };

                // 3. Salva os dados no Firestore
                await definirDocumento("essays", essayId, essayData);
                
                submissionStatus.innerHTML = `<strong>Sucesso!</strong> Sua redação foi enviada e corrigida pela IA.`;
                submitEssayButton.style.display = 'none';
                document.getElementById('upload-area').style.pointerEvents = 'none';
                document.getElementById('upload-area').style.opacity = '0.6';

                localStorage.removeItem('essaySession');

            } catch (error) {
                console.error("Erro no processo de envio:", error);
                submissionStatus.textContent = 'Ocorreu um erro ao enviar. Tente novamente.';
                submitEssayButton.disabled = false;
                submitEssayButton.textContent = 'Enviar Redação';
            }
        }
        
        // ========================================================
        // ==  ANIMAÇÃO DE FUNDO (CONSTELLATION)                 ==
        // ========================================================
        const canvas = document.getElementById('constellation-background');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const words = ['TESE', 'ARGUMENTO', 'PROPOSTA', 'REPERTÓRIO', 'COESÃO', 'ENEM', 'CIDADANIA', 'DIREITOS', 'CONTEXTO', 'INTERVENÇÃO', 'CONECTOR'];
        let particlesArray = [];
        class WordParticle{constructor(){this.x=Math.random()*canvas.width;this.y=Math.random()*canvas.height;this.directionX=(Math.random()*.3)-.15;this.directionY=(Math.random()*.3)-.15;this.size=12;this.text=words[Math.floor(Math.random()*words.length)]}draw(){ctx.font=this.size+'px Poppins';ctx.fillStyle='rgba(122, 130, 145, 0.5)';ctx.fillText(this.text,this.x,this.y)}update(){if(this.x>canvas.width||this.x<0)this.directionX=-this.directionX;if(this.y>canvas.height||this.y<0)this.directionY=-this.directionY;this.x+=this.directionX;this.y+=this.directionY;this.draw()}}
        function init(){particlesArray=[];let numberOfParticles=(canvas.height*canvas.width)/3e4;for(let i=0;i<numberOfParticles;i++){particlesArray.push(new WordParticle)}}
        function connect(){let opacityValue=1;for(let a=0;a<particlesArray.length;a++){for(let b=a;b<particlesArray.length;b++){let distance=Math.sqrt(Math.pow(particlesArray[a].x-particlesArray[b].x,2)+Math.pow(particlesArray[a].y-particlesArray[b].y,2));if(distance<250){opacityValue=1-(distance/250);ctx.strokeStyle=`rgba(0, 168, 255, ${opacityValue*.2})`;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(particlesArray[a].x,particlesArray[a].y);ctx.lineTo(particlesArray[b].x,particlesArray[b].y);ctx.stroke()}}}}
        function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);for(let i=0;i<particlesArray.length;i++){particlesArray[i].update()}connect();requestAnimationFrame(animate)}
        window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;init()});init();animate();
    </script>
    </body>
</html>

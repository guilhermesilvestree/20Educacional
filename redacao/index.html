<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redação | Evolução Educacional</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="assets/icon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>

    <style>
        :root {
            --cor-fundo: #F4F4F6; --cor-container: #FFFFFF; --cor-texto-principal: #333A45;
            --cor-texto-sutil: #7A8291; --cor-borda: #EAEBEE; --cor-acento: #00A8FF;
            --cor-acento-hover: #008DD1; --cor-alerta: #E5A05B; --cor-perigo: #C96464;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html, body {
            height: 100%; background-color: var(--cor-fundo); color: var(--cor-texto-principal);
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        #constellation-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .page-container { width: 100%; max-width: 1100px; position: relative; z-index: 1; display: flex; justify-content: center; }
        .step-container {
            display: none; flex-direction: column; align-items: center; gap: 20px;
            background: var(--cor-container); border-radius: 15px; box-shadow: 0 16px 40px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--cor-borda); padding: 50px; animation: fadeIn 0.6s ease; width: 100%;
        }
        .step-container.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .back-button-fixed {
            position: fixed; top: 30px; left: 30px; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; background: var(--cor-container); color: var(--cor-acento); 
            border-radius: 50%; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--cor-borda); text-decoration: none; font-size: 1rem; transition: all 0.3s ease;
        }
        .back-button-fixed:hover { transform: scale(1.1); }
        h1 { font-size: 2.2rem; font-weight: 700; color: var(--cor-acento); text-align: center; }
        p { font-size: 1.1rem; color: var(--cor-texto-sutil); text-align: center; line-height: 1.7; max-width: 550px; }
        .action-button {
            margin-top: 10px; padding: 14px 35px; font-size: 1.1rem; font-weight: 600;
            border-radius: 50px; border: none; cursor: pointer; transition: all 0.3s ease;
            color: #FFFFFF; background-color: var(--cor-acento); box-shadow: 0 4px 15px rgba(0, 168, 255, 0.25);
        }
        .action-button:hover { background-color: var(--cor-acento-hover); transform: translateY(-2px); }
        .action-button:disabled { background-color: #B0B8C5; cursor: not-allowed; box-shadow: none; transform: none; }
        .action-button .fa-spin { margin-right: 10px; }
        #instructions-step ul { list-style: none; padding: 0; width: 100%; max-width: 600px; margin-top: 20px; }
        #instructions-step li { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 25px; color: var(--cor-texto-principal); line-height: 1.6; font-size: 1rem; }
        #instructions-step li i { color: var(--cor-acento); font-size: 1.3rem; margin-top: 3px; width: 25px; text-align: center; }
        .preparation-gif { width: 180px; height: auto; margin-bottom: 10px; }
        #writing-step {
            padding: 20px; user-select: none; -webkit-user-select: none;
            -ms-user-select: none; -moz-user-select: none; background-color: #F9FAFB;
            max-height: 90vh; overflow-y: auto;
        }
        .writing-dashboard { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .dashboard-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 10px; border-bottom: 1px solid var(--cor-borda); flex-wrap: wrap; gap: 15px;
        }
        .user-info { display: flex; align-items: center; gap: 12px; font-size: 1.0rem; font-weight: 500; }
        .user-avatar-small { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        #student-name-display { font-weight: 600; }
        .datetime-info { font-size: 0.9rem; color: var(--cor-texto-sutil); text-align: right; }
        #current-time { font-weight: 600; }
        .dashboard-main { display: flex; flex-wrap: wrap; gap: 15px; width: 100%; }
        .left-column { flex: 1 1 280px; display: flex; flex-direction: column; gap: 15px; min-width: 280px; }
        .right-column { flex: 2 1 400px; display: flex; }
        .widget {
            background: var(--cor-container); border-radius: 16px; padding: 18px;
            border: 1px solid var(--cor-borda); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            display: flex; flex-direction: column; width: 100%;
        }
        .widget-title {
            font-size: 1.0rem; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px;
            border-bottom: 1px solid var(--cor-borda); display: flex; align-items: center; gap: 10px;
        }
        .widget-title i { color: var(--cor-acento); }
        .timer-widget { align-items: center; }
        .timer-container { position: relative; width: 160px; height: 160px; }
        .timer-svg { transform: rotate(-90deg); }
        .timer-bg, .timer-progress { fill: none; stroke-width: 12; }
        .timer-bg { stroke: var(--cor-borda); }
        .timer-progress { stroke: var(--cor-acento); stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.5s; }
        .timer-progress.warning { stroke: var(--cor-alerta); }
        .timer-progress.danger { stroke: var(--cor-perigo); animation: timerFlash 1s infinite; }
        #timer-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.0rem; }
        #checklist-lembretes { list-style: none; padding: 0; }
        #checklist-lembretes li { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; color: var(--cor-texto-sutil); font-size: 0.9rem; }
        #checklist-lembretes i { color: var(--cor-sucesso, #28a745); font-size: 1.0rem; }
        #theme-title { color: var(--cor-texto-principal); font-size: 1.3rem; font-weight: 600; text-align: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--cor-borda); }
        #theme-text { font-size: 0.95rem; line-height: 1.7; color: var(--cor-texto-sutil); flex-grow: 1; text-align: center; }
        @keyframes timerFlash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #times-up-step .times-up-icon { width: 80px; height: 80px; color: var(--cor-acento); margin-bottom: 15px; animation: pulseIcon 2s infinite ease-in-out; }
        @keyframes pulseIcon { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.08); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .auto-redirect-indicator { margin-top: 30px; width: 100%; max-width: 350px; text-align: center; }
        .auto-redirect-indicator .redirect-text { font-size: 0.95rem; color: var(--cor-texto-sutil); margin-bottom: 12px; }
        .progress-bar-container { width: 100%; height: 8px; background-color: var(--cor-borda); border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .progress-bar-fill { width: 0%; height: 100%; background-color: var(--cor-acento); border-radius: 4px; animation: fillProgressBar 4s linear forwards; }
        @keyframes fillProgressBar { from { width: 0%; } to { width: 100%; } }
        #submission-step { max-width: 650px; text-align: left; align-items: stretch; gap: 25px; }
        .submission-header { display: flex; align-items: center; gap: 15px; padding-bottom: 20px; border-bottom: 1px solid var(--cor-borda); }
        .submission-header .user-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--cor-borda); flex-shrink: 0; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .submission-header .user-details { flex-grow: 1; }
        .submission-header #submission-student-name { font-weight: 600; font-size: 1.2rem; color: var(--cor-texto-principal); }
        .submission-header #submission-time { font-size: 0.9rem; color: var(--cor-texto-sutil); }
        .submission-summary { background-color: #F9FAFB; padding: 20px; border-radius: 16px; border: 1px solid var(--cor-borda); }
        .submission-summary h3 { font-size: 1rem; font-weight: 600; margin-bottom: 8px; color: var(--cor-texto-principal); }
        .submission-summary p { font-size: 0.95rem; text-align: left; max-width: 100%; line-height: 1.6; }
        #submission-step > p { text-align: center; max-width: 100%; }
        .upload-area {
            border: 2px dashed var(--cor-acento); border-radius: 16px; padding: 40px 30px;
            text-align: center; cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s ease;
            background-color: #F9FAFB;
        }
        .upload-area:hover { background-color: #F0F5FA; border-color: var(--cor-acento-hover); }
        .upload-area i { font-size: 3rem; color: var(--cor-acento); margin-bottom: 15px; }
        .upload-area p { font-size: 1.1rem; font-weight: 600; color: var(--cor-texto-principal); }
        .upload-area span { font-size: 0.9rem; color: var(--cor-texto-sutil); }
        #photo-input { display: none; }
        .photo-tips-link { color: var(--cor-acento); text-decoration: none; font-weight: 500; font-size: 0.9rem; cursor: pointer; text-align: center; }
        .photo-tips-link:hover { text-decoration: underline; }
        #submission-status { font-size: 0.9rem; margin-top: 5px; min-height: 1.2em; color: var(--cor-texto-sutil); text-align: center; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 100;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-backdrop.active { display: flex; }
        .modal-content {
            background: var(--cor-container); padding: 40px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 550px;
            animation: fadeIn 0.4s ease; text-align: center;
        }
        .modal-content h2 { text-align: center; margin-bottom: 15px; font-size: 1.6rem; color: var(--cor-texto-principal); }
        .tips-list { list-style: none; padding: 0; margin-bottom: 30px; }
        .tips-list li { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px; }
        .tips-list li i { font-size: 1.5rem; color: var(--cor-acento); margin-top: 2px; }
        .tips-list li p { text-align: left; font-size: 1rem; color: var(--cor-texto-sutil); line-height: 1.6; }
        @media (max-width: 768px) {
            .step-container { padding: 40px 25px; } h1 { font-size: 1.8rem; }
            .preparation-gif { width: 150px; }
            .dashboard-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .datetime-info { text-align: left; } #writing-step { padding: 25px 15px; }
        }
    </style>
</head>
<body>
    
    <canvas id="constellation-background"></canvas>

    <a href="../linguagens.html" class="back-button-fixed">
        <i class="fa-solid fa-chevron-left"></i>
    </a>

    <div class="page-container">

        <div id="instructions-step" class="step-container active">
            <h1>Sua Jornada de Escrita</h1>
            <p>Prepare-se para transformar suas ideias em palavras. Siga as diretrizes para uma redação de sucesso.</p>
            <ul>
                <li><i class="fa-solid fa-hourglass-half"></i><div><strong>Tempo de Foco:</strong> Você terá 1 hora para desenvolver seu texto.</div></li>
                <li><i class="fa-solid fa-file-pen"></i><div><strong>Estrutura:</strong> Escreva um texto dissertativo-argumentativo com até 30 linhas.</div></li>
                <li><i class="fa-solid fa-lightbulb"></i><div><strong>Argumentação:</strong> Defenda seu ponto de vista com argumentos claros, consistentes e bem fundamentados.</div></li>
                <li><i class="fa-solid fa-people-group"></i><div><strong>Proposta de Intervenção:</strong> Elabore uma solução para o problema, respeitando os direitos humanos.</div></li>
                <li><i class="fa-solid fa-pen-nib"></i><div><strong>Material:</strong> Utilize caneta de tinta preta e escreva em uma folha de papel.</div></li>
            </ul>
            <button id="understand-button" class="action-button">Entendi, vamos começar!</button>
        </div>

        <div id="preparation-step" class="step-container">
            <img src="assets/anim_escrevendo.gif" class="preparation-gif" alt="Animação de uma pessoa se preparando para escrever">
            <h1>Momento de Preparação</h1>
            <p>Organize seus materiais e encontre um lugar tranquilo. Respire fundo. Sua jornada de escrita começa agora.</p>
            <button id="start-button" class="action-button">Estou Pronto para Iniciar</button>
        </div>

        <div id="writing-step" class="step-container">
            <div class="writing-dashboard">
                <header class="dashboard-header">
                    <div class="user-info">
                        <img id="writing-user-avatar-img" src="assets/default-avatar.png" alt="Avatar" class="user-avatar-small">
                        <span>Olá, <strong id="student-name-display">...</strong></span>
                    </div>
                    <div class="datetime-info">
                        <span id="current-date">--/--/----</span>
                        <br>
                        <span id="current-time">--:--:--</span>
                    </div>
                </header>

                <main class="dashboard-main">
                    <div class="left-column">
                        <div class="widget timer-widget">
                            <h3 class="widget-title"><i class="fa-solid fa-stopwatch"></i>Tempo Restante</h3>
                            <div class="timer-container">
                                <svg class="timer-svg" width="160" height="160" viewBox="0 0 160 160">
                                    <circle class="timer-bg" cx="80" cy="80" r="74"></circle>
                                    <circle id="timer-progress" class="timer-progress" cx="80" cy="80" r="74"></circle>
                                </svg>
                                <div id="timer-text">01:00:00</div>
                            </div>
                        </div>
                        <div class="widget">
                            <h3 class="widget-title"><i class="fa-solid fa-list-check"></i>Checklist</h3>
                             <ul id="checklist-lembretes">
                                <li><i class="fa-solid fa-check-circle"></i> Dissertativo-argumentativo</li>
                                <li><i class="fa-solid fa-check-circle"></i> Proposta de intervenção</li>
                                <li><i class="fa-solid fa-check-circle"></i> Respeito aos direitos humanos</li>
                                <li><i class="fa-solid fa-check-circle"></i> Mínimo de 7 linhas</li>
                                <li><i class="fa-solid fa-check-circle"></i> Máximo de 30 linhas</li>
                            </ul>
                        </div>
                    </div>

                    <div class="right-column">
                        <div class="widget theme-widget">
                             <h3 class="widget-title"><i class="fa-solid fa-book-open"></i>Tema da Redação</h3>
                            <h2 id="theme-title">Tema da Redação</h2>
                            <p id="theme-text">Texto motivador será carregado aqui.</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="times-up-step" class="step-container">
            <svg class="times-up-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h1>Tempo Esgotado!</h1>
            <p>Excelente esforço! Pare de escrever e prepare-se para enviar sua redação.</p>
            <div class="auto-redirect-indicator">
                <p class="redirect-text">Avançando para a etapa de envio...</p>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill"></div>
                </div>
            </div>
        </div>

        <div id="submission-step" class="step-container">
            <header class="submission-header">
                <div class="user-avatar">
                    <img id="user-avatar-img" src="assets/default-avatar.png" alt="Avatar do Aluno">
                </div>
                <div class="user-details">
                    <span id="submission-student-name">Carregando...</span>
                    <div id="submission-time">Finalizado em --/--/---- às --:--</div>
                </div>
            </header>

            <div class="submission-summary">
                <h3>Resumo da Atividade</h3>
                <p id="submission-theme-title">Carregando tema da redação...</p>
            </div>

            <p>Tire uma foto nítida da sua redação. Nossa plataforma irá transcrever e preparar seu texto para a avaliação.</p>
            <a id="open-tips-modal" class="photo-tips-link">Ver dicas para uma boa foto</a>

            <label for="photo-input" class="upload-area" id="upload-area">
                <i class="fa-solid fa-camera"></i>
                <p id="upload-area-text">Abrir Câmera</p>
                <span>Fotografe a folha inteira da sua redação</span>
            </label>
            <input type="file" id="photo-input" accept="image/*" capture="environment">
            <button class="action-button" id="submit-essay-button" disabled>Enviar Redação</button>

            <p id="submission-status"></p>
        </div>
    </div>

    <div class="modal-backdrop" id="modal-backdrop">
        <div class="modal-content">
            <h2>Dicas para uma Foto Perfeita</h2>
            <div id="lottie-animation-container" style="width: 150px; height: 150px; margin: 0 auto 20px;"></div>
            <ul class="tips-list">
                <li><i class="fa-solid fa-lightbulb"></i><p><strong>Iluminação:</strong> Procure um local bem iluminado. Evite sombras fortes sobre o texto.</p></li>
                <li><i class="fa-solid fa-expand"></i><p><strong>Enquadramento:</strong> Posicione a câmera diretamente acima da folha, garantindo que ela apareça inteira.</p></li>
                <li><i class="fa-solid fa-camera"></i><p><strong>Foco e Nitidez:</strong> Segure o celular com firmeza e toque na tela para focar. A imagem precisa estar nítida.</p></li>
            </ul>
            <button class="action-button" id="close-tips-modal">Entendi</button>
        </div>
    </div>
    
    <div class="modal-backdrop" id="no-themes-modal">
        <div class="modal-content">
            <h2 style="font-size: 1.8rem;"><i class="fa-solid fa-calendar-times" style="color: var(--cor-alerta); margin-right: 10px;"></i>Ops!</h2>
            <p style="max-width: 100%; margin-top: 10px;">Ainda não há temas de redação definidos para esta semana. Por favor, volte mais tarde!</p>
            <button class="action-button" id="close-no-themes-modal" style="margin-top: 25px;">Entendi</button>
        </div>
    </div>


    <script type="module">
        // ========================================================
        // ==  IMPORTAÇÕES DOS MÓDULOS                          ==
        // ========================================================
        import { auth, db } from '../firebase/firebase-config.js';
        import { serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { gerarIdDocumento, definirDocumento, uploadArquivoCloudinary } from '../firebase/firebase-services.js';

        // ========================================================
        // ==  LÓGICA DE ARMAZENAMENTO CENTRALIZADO              ==
        // ========================================================
        const APP_STORAGE_KEY = 'perfilUser';

        function getAppData() {
            try {
                const rawData = localStorage.getItem(APP_STORAGE_KEY);
                return rawData ? JSON.parse(rawData) : { userData: {}, essaySession: null };
            } catch (e) {
                console.error("Failed to parse app data from localStorage", e);
                return { userData: {}, essaySession: null };
            }
        }

        function saveAppData(data) {
            try {
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Failed to save app data to localStorage", e);
            }
        }

        // ========================================================
        // ==  VARIÁVEIS GLOBAIS E ELEMENTOS DO DOM              ==
        // ========================================================
        const steps = {
            instructions: document.getElementById('instructions-step'),
            preparation: document.getElementById('preparation-step'),
            writing: document.getElementById('writing-step'),
            timesUp: document.getElementById('times-up-step'),
            submission: document.getElementById('submission-step')
        };

        const understandButton = document.getElementById('understand-button');
        const startButton = document.getElementById('start-button');
        const photoInput = document.getElementById('photo-input');
        const submissionStatus = document.getElementById('submission-status');
        const submitEssayButton = document.getElementById('submit-essay-button');
        const studentNameDisplay = document.getElementById('student-name-display');
        const currentDateDisplay = document.getElementById('current-date');
        const currentTimeDisplay = document.getElementById('current-time');
        
        let currentTheme = null;
        let timerInterval;
        let currentRemainingSeconds;
        
        let currentStudentName = "";
        let currentAvatarUrl = "assets/gui.jpeg";
        let currentStudentUid = null;

        const TOTAL_ESSAY_TIME = 10; // 1 hora em segundos

        // ========================================================
        // ==  LÓGICA DE NAVEGAÇÃO E CONTROLE DOS PASSOS (STEPS) ==
        // ========================================================
        function showStep(stepName) {
            Object.values(steps).forEach(step => step.classList.remove('active'));
            if (steps[stepName]) {
                steps[stepName].classList.add('active');
            }
        }

        understandButton.addEventListener('click', () => showStep('preparation'));
        
        // --- LÓGICA DE BUSCA DE TEMA (NOVA) ---

        async function fetchWeeklyThemes() {
            const themesRef = collection(db, "themes");
            const q = query(themesRef, where("isCurrentWeek", "==", true));
            const querySnapshot = await getDocs(q);
            const weeklyThemes = [];
            querySnapshot.forEach((doc) => {
                weeklyThemes.push({ id: doc.id, ...doc.data() });
            });
            return weeklyThemes;
        }

        startButton.addEventListener('click', async () => {
            startButton.disabled = true;
            startButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Carregando tema...';

            try {
                const weeklyThemes = await fetchWeeklyThemes();

                if (weeklyThemes.length === 0) {
                    document.getElementById('no-themes-modal').classList.add('active');
                    startButton.disabled = false;
                    startButton.textContent = 'Estou Pronto para Iniciar';
                    return;
                }

                const randomTheme = weeklyThemes[Math.floor(Math.random() * weeklyThemes.length)];
                startEssay(randomTheme);

            } catch (error) {
                console.error("Erro ao buscar temas da semana:", error);
                alert("Ocorreu um erro ao buscar o tema. Por favor, tente novamente.");
                startButton.disabled = false;
                startButton.textContent = 'Estou Pronto para Iniciar';
            }
        });

        function startEssay(theme) {
            showStep('writing');
            currentTheme = theme;
            
            document.getElementById('theme-title').innerText = theme.title;
            document.getElementById('theme-text').innerText = theme.text;
            
            studentNameDisplay.innerText = currentStudentName;
            document.getElementById('writing-user-avatar-img').src = currentAvatarUrl;

            const sessionData = {
                creationTime: Date.now(),
                remainingSeconds: TOTAL_ESSAY_TIME,
                theme: theme,
                status: 'writing'
            };
            
            const appData = getAppData();
            appData.essaySession = sessionData;
            saveAppData(appData);

            startTimer(TOTAL_ESSAY_TIME);
        }

        // ========================================================
        // == LÓGICA DA TELA DE SUBMISSÃO E MODAIS       ==
        // ========================================================
        const modalBackdrop = document.getElementById('modal-backdrop');
        const openTipsModalLink = document.getElementById('open-tips-modal');
        const closeTipsModalButton = document.getElementById('close-tips-modal');
        const noThemesModal = document.getElementById('no-themes-modal');
        const closeNoThemesModal = document.getElementById('close-no-themes-modal');
        let lottieAnimation = null;

        function toggleModal(modal, show) { modal.classList.toggle('active', show); }
        
        openTipsModalLink.addEventListener('click', () => {
            toggleModal(modalBackdrop, true);
            if (!lottieAnimation) {
                lottieAnimation = lottie.loadAnimation({
                    container: document.getElementById('lottie-animation-container'),
                    renderer: 'svg', loop: true, autoplay: true,
                    path: 'assets/gifs/photo.lottie'
                });
            }
        });
        closeTipsModalButton.addEventListener('click', () => toggleModal(modalBackdrop, false));
        modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) toggleModal(modalBackdrop, false); });

        closeNoThemesModal.addEventListener('click', () => toggleModal(noThemesModal, false));
        noThemesModal.addEventListener('click', (e) => { if (e.target === noThemesModal) toggleModal(noThemesModal, false); });
        
        function prepareSubmissionStep() {
            const now = new Date();
            const date = now.toLocaleDateString('pt-BR');
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            document.getElementById('submission-student-name').textContent = currentStudentName;
            document.getElementById('submission-time').textContent = `Finalizado em ${date} às ${time}`;
            if(currentTheme) {
                document.getElementById('submission-theme-title').textContent = currentTheme.title;
            }
            document.getElementById('user-avatar-img').src = currentAvatarUrl;
        }

        // ========================================================
        // ==  LÓGICA DA REDAÇÃO (TIMER)                  ==
        // ========================================================
        function handleTimesUp() {
            const appData = getAppData();
            if (appData.essaySession) {
                appData.essaySession.status = 'timesUp';
                saveAppData(appData);
            }

            showStep('timesUp');
            prepareSubmissionStep();
            
            setTimeout(() => {
                const currentAppData = getAppData();
                if (currentAppData.essaySession) {
                    currentAppData.essaySession.status = 'submission';
                    saveAppData(currentAppData);
                }
                showStep('submission');
            }, 4000);
        }

        const timerText = document.getElementById('timer-text');
        const timerProgress = document.getElementById('timer-progress');
        
        function setProgress(percent) {
            const radius = timerProgress.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            timerProgress.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - (percent / 100) * circumference;
            timerProgress.style.strokeDashoffset = offset;
        }

        function startTimer(duration) {
            clearInterval(timerInterval);
            currentRemainingSeconds = Number(duration) || 0;

            const updateDisplay = () => {
                let hours = Math.floor(currentRemainingSeconds / 3600);
                let minutes = Math.floor((currentRemainingSeconds % 3600) / 60);
                let seconds = Math.floor(currentRemainingSeconds % 60);
                
                hours = hours < 10 ? "0" + hours : hours;
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timerText.textContent = `${hours}:${minutes}:${seconds}`;
                
                const progressPercent = (currentRemainingSeconds / TOTAL_ESSAY_TIME) * 100;
                setProgress(progressPercent);
                
                timerProgress.classList.remove('warning', 'danger');
                if (currentRemainingSeconds <= 300) { timerProgress.classList.add('danger'); } 
                else if (currentRemainingSeconds <= 600) { timerProgress.classList.add('warning'); }
            };

            updateDisplay();

            timerInterval = setInterval(() => {
                if (--currentRemainingSeconds < 0) {
                    clearInterval(timerInterval);
                    handleTimesUp();
                } else {
                    updateDisplay();
                }
            }, 1000);
        }

        function updateDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            currentDateDisplay.textContent = now.toLocaleDateString('pt-BR', dateOptions);
            currentTimeDisplay.textContent = now.toLocaleTimeString('pt-BR');
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        function restoreEssaySession() {
            const appData = getAppData();
            const sessionData = appData.essaySession;

            if (!sessionData) {
                showStep('instructions');
                return;
            }
            
            currentTheme = sessionData.theme;

            if (sessionData.status === 'submission') {
                prepareSubmissionStep();
                showStep('submission');
                return;
            }

            if (sessionData.status === 'timesUp') {
                prepareSubmissionStep();
                showStep('timesUp');
                setTimeout(() => {
                    const currentAppData = getAppData();
                    if(currentAppData.essaySession) {
                        currentAppData.essaySession.status = 'submission';
                        saveAppData(currentAppData);
                    }
                    showStep('submission');
                }, 4000);
                return;
            }
            
            const elapsedTime = (Date.now() - sessionData.creationTime) / 1000;
            const remainingSeconds = sessionData.remainingSeconds - elapsedTime;

            if (remainingSeconds <= 0) {
                handleTimesUp();
                return;
            }
            
            showStep('writing');
            document.getElementById('theme-title').innerText = currentTheme.title;
            document.getElementById('theme-text').innerText = currentTheme.text;
            studentNameDisplay.innerText = currentStudentName;
            document.getElementById('writing-user-avatar-img').src = currentAvatarUrl;
            startTimer(remainingSeconds);
        }
        
        function saveCurrentTime() {
            const appData = getAppData();
            if (!appData.essaySession || !currentTheme) return;
            appData.essaySession.remainingSeconds = currentRemainingSeconds;
            appData.essaySession.creationTime = Date.now();
            saveAppData(appData);
        }

        function initializePage() {
            const appData = getAppData();
            const savedUser = appData.userData;

            if (savedUser && savedUser.name && savedUser.uid) {
                currentStudentName = savedUser.name;
                currentStudentUid = savedUser.uid;
                if (savedUser.avatar) {
                    currentAvatarUrl = savedUser.avatar;
                }
                restoreEssaySession();
            } else {
                window.location.href = '../index.html'; 
                return; 
            }

            window.addEventListener('beforeunload', saveCurrentTime);
        }

        document.addEventListener('DOMContentLoaded', initializePage);

        // ========================================================
        // ==  LÓGICA DE UPLOAD E SUBMISSÃO                      ==
        // ========================================================
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('upload-area-text').textContent = file.name;
                submitEssayButton.disabled = false;
            }
        });

        submitEssayButton.addEventListener('click', () => {
            const file = photoInput.files[0];
            if (file) { handlePhotoUpload(file); } 
            else { alert("Por favor, selecione uma foto antes de enviar."); }
        });

        async function getGeminiAnalysisAndTranscription(theme, imageFile) {
            const apiKey = "AIzaSyB7ygXwm0Zw39QrS9oV6D8P1qqZ5BmRhrM";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            submissionStatus.textContent = 'Convertendo imagem para análise...';
            const base64Image = await fileToBase64(imageFile);
            
            const schema = {
                type: "OBJECT",
                properties: {
                    transcribedText: { type: "STRING" },
                    grades: {
                        type: "OBJECT",
                        properties: {
                            competencia1: { type: "NUMBER" }, competencia2: { type: "NUMBER" },
                            competencia3: { type: "NUMBER" }, competencia4: { type: "NUMBER" },
                            competencia5: { type: "NUMBER" }, total: { type: "NUMBER" }
                        }
                    },
                    feedback: {
                        type: "OBJECT",
                        properties: {
                            positive: { type: "STRING" },
                            difficulties: { type: "STRING" },
                            suggestions: { type: "STRING" }
                        }
                    },
                    errors: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                snippet: { type: "STRING" },
                                type: { type: "STRING" },
                                suggestion: { type: "STRING" }
                            }
                        }
                    }
                }
            };
            
            // PROMPT ATUALIZADO: A instrução na Etapa 5 foi refinada para pedir uma explicação.
            const prompt = `Sua tarefa é agir como um corretor especialista do ENEM. Realize as seguintes etapas:
            1. **Transcrição:** Transcreva CUIDADOSAMENTE e fielmente o texto manuscrito da imagem. Se o texto for ilegível, retorne "____" no campo 'transcribedText'.
            2. **Análise e Avaliação:** Usando o texto transcrito, analise a redação com o tema "${theme}" com base nas 5 competências do ENEM. Atribua uma nota de 0 a 200 para cada uma, **obrigatoriamente em múltiplos de 40**.
            3. **Cálculo da Nota:** Calcule a nota total.
            4. **Feedback Estruturado:** Forneça um feedback detalhado, direto e conciso.
            5. **Detecção de Erros:** Identifique desvios gramaticais, ortográficos ou de coesão. Para cada erro, forneça o trecho exato ('snippet'), o tipo de erro ('type', ex: 'Concordância Verbal') e uma explicação curta e objetiva ('suggestion') que justifique o erro (ex: 'O verbo "haver", no sentido de "existir", é impessoal e deve ficar no singular: "Houve".'). Se nenhum erro for encontrado, retorne um array vazio.
            Responda estritamente no formato JSON definido no schema.`;
            
            const payload = { contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: imageFile.type, data: base64Image } } ] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };

            try {
                submissionStatus.textContent = 'Transcrevendo e analisando com a IA...';
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API request failed with status ${response.status}`); }
                const result = await response.json();
                console.log("Resposta da API do Gemini:", result);
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } catch (error) {
                console.error("Erro ao chamar a API do Gemini:", error);
                return { transcribedText: "Erro na transcrição.", grades: { total: 0 }, feedback: { difficulties: "Ocorreu um erro durante a comunicação com a IA." }, errors: [] };
            }
        }

        async function handlePhotoUpload(file) {
            if (!currentStudentName || !currentTheme || !currentStudentUid) { 
                alert('Erro: Dados da sessão do usuário não encontrados.'); 
                return; 
            }
            if (!auth.currentUser) { 
                alert('Erro de autenticação. A página será recarregada.'); 
                location.reload(); 
                return; 
            }

            submitEssayButton.disabled = true;
            submitEssayButton.textContent = 'Enviando...';
            submissionStatus.textContent = 'Aguarde, preparando sua redação para análise...';

            try {
                const analysis = await getGeminiAnalysisAndTranscription(currentTheme.title, file);
                submissionStatus.textContent = 'Análise concluída. Enviando para o servidor...';
                const essayId = gerarIdDocumento("essays");
                const sanitizedStudentName = currentStudentName.replace(/\s+/g, '-').toLowerCase();
                const publicFilename = `${sanitizedStudentName}-${essayId}`;
                const fileURL = await uploadArquivoCloudinary(file, publicFilename);
                
                const essayData = {
                    id: essayId, 
                    studentUid: currentStudentUid,
                    studentName: currentStudentName, 
                    studentAvatar: currentAvatarUrl,
                    themeTitle: currentTheme.title, 
                    essayImageURL: fileURL, 
                    essayImagePublicId: publicFilename,
                    submissionDate: serverTimestamp(),
                    status: 'corrigido-ia', 
                    transcribedText: analysis.transcribedText,
                    feedback: analysis.feedback, 
                    grades: analysis.grades,
                    errors: analysis.errors || [] // Adiciona os erros ao objeto de dados
                };

                await definirDocumento("essays", essayId, essayData);
                
                submissionStatus.innerHTML = `<strong>Sucesso!</strong> Sua redação foi enviada e corrigida.`;
                submitEssayButton.style.display = 'none';
                document.getElementById('upload-area').style.pointerEvents = 'none';
                document.getElementById('upload-area').style.opacity = '0.6';

                const appData = getAppData();
                appData.essaySession = null;
                saveAppData(appData);

            } catch (error) {
                console.error("Erro no processo de envio:", error);
                submissionStatus.textContent = 'Ocorreu um erro ao enviar. Tente novamente.';
                submitEssayButton.disabled = false;
                submitEssayButton.textContent = 'Enviar Redação';
            }
        }
        
        // ========================================================
        // ==  ANIMAÇÃO DE FUNDO (CONSTELLATION)                 ==
        // ========================================================
        const canvas = document.getElementById('constellation-background'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const words = ['TESE', 'ARGUMENTO', 'PROPOSTA', 'REPERTÓRIO', 'COESÃO', 'ENEM', 'CIDADANIA', 'DIREITOS', 'CONTEXTO', 'INTERVENÇÃO', 'CONECTOR'];
        let particlesArray = [];
        class WordParticle{constructor(){this.x=Math.random()*canvas.width;this.y=Math.random()*canvas.height;this.directionX=(Math.random()*.3)-.15;this.directionY=(Math.random()*.3)-.15;this.size=12;this.text=words[Math.floor(Math.random()*words.length)]}draw(){ctx.font=this.size+'px Poppins';ctx.fillStyle='rgba(122, 130, 145, 0.5)';ctx.fillText(this.text,this.x,this.y)}update(){if(this.x>canvas.width||this.x<0)this.directionX=-this.directionX;if(this.y>canvas.height||this.y<0)this.directionY=-this.directionY;this.x+=this.directionX;this.y+=this.directionY;this.draw()}}
        function init(){particlesArray=[];let numberOfParticles=(canvas.height*canvas.width)/3e4;for(let i=0;i<numberOfParticles;i++){particlesArray.push(new WordParticle)}}
        function connect(){let opacityValue=1;for(let a=0;a<particlesArray.length;a++){for(let b=a;b<particlesArray.length;b++){let distance=Math.sqrt(Math.pow(particlesArray[a].x-particlesArray[b].x,2)+Math.pow(particlesArray[a].y-particlesArray[b].y,2));if(distance<250){opacityValue=1-(distance/250);ctx.strokeStyle=`rgba(0, 168, 255, ${opacityValue*.2})`;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(particlesArray[a].x,particlesArray[a].y);ctx.lineTo(particlesArray[b].x,particlesArray[b].y);ctx.stroke()}}}}
        function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);for(let i=0;i<particlesArray.length;i++){particlesArray[i].update()}connect();requestAnimationFrame(animate)}
        window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;init()});init();animate();
    </script>
    </body>
</html>